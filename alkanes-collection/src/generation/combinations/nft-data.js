const specialBackgrounds = [
  "Alkane Pandas.png",
  "Dead Alkanes.png",
  "Oyly.png",
  "Holographic.png",
  "Orbinauts.png",
  "Alchemist.png",
  "Airhead.png",
  "Satonomy.png",
  "Square Head.png",
  "Dark Force.png",
  "Light Force.png",
]

const multiColorBody = [
  "Blazer.png",
  "Hooded Sweatshirt.png",
  "Leather Jacket.png",
  "Suit.png",
]

const traitFiles = {
  Background: [
    "Blue.png",
    "Green.png",
    "Cyan.png",
    "Red.png",
    "Purple.png",
    "Stars.png",
    "City.png",
    "Alkane Pandas.png",
    "Dead Alkanes.png",
    "Oyly.png",
    "Holographic.png",
    "Orbinauts.png",
    "Alchemist.png",
    "Airhead.png",
    "Satonomy.png",
    "Square Head.png",
    "Dark Force.png",
    "Light Force.png",
  ],
  Back: [
    "Fairy Wings.png",
    "Backpack.png",
    "Imp Wings.png",
    "Drone 01.png",
    "Drone 03.png",
    "Drone 02.png",
    "Jetpack.png",
    "Golden Wings.png",
    "Golden Jetpack.png",
    "Angel Wings.png",
    "None.png",
  ],
  Body: [
    "Red Mainframe 09.png",
    "Hooded Sweatshirt.png",
    "Lab Coat.png",
    "Red Mainframe 08.png",
    "Red Plumber Overalls.png",
    "Suit.png",
    "Leather Jacket.png",
    "Red Skull Shirt.png",
    "Skull Shirt.png",
    "Butcher Apron.png",
    "Green Butcher Apron.png",
    "Mainframe 03.png",
    "Blue Mainframe 07.png",
    "Blue Mainframe 06.png",
    "Mainframe 02.png",
    "Blue Mainframe 04.png",
    "Blue Mainframe 10.png",
    "Blue Mainframe 05.png",
    "Golden Frame.png",
    "Mainframe 01.png",
    "Mainframe 05.png",
    "Blue Mainframe 01.png",
    "Mainframe 10.png",
    "Mainframe 04.png",
    "Mainframe 06.png",
    "Green Mainframe 09.png",
    "Blue Mainframe 02.png",
    "Green Plumber Overalls.png",
    "Blue Mainframe 03.png",
    "Mainframe 07.png",
    "Green Mainframe 08.png",
    "Green Mainframe 05.png",
    "Golden Chassis.png",
    "Golden Hull.png",
    "Green Mainframe 10.png",
    "Mainframe 09.png",
    "Red Butcher Apron.png",
    "Mainframe 08.png",
    "Green Mainframe 03.png",
    "Blue Mainframe 08.png",
    "Blue Mainframe 09.png",
    "Green Mainframe 02.png",
    "Green Mainframe 01.png",
    "Plumber Overalls.png",
    "Red Mainframe 06.png",
    "Striped Shirt.png",
    "Red Mainframe 05.png",
    "Red Lab Coat.png",
    "Red Mainframe 10.png",
    "Red Mainframe 04.png",
    "Blazer.png",
    "None.png",
  ],
  Head: [
    "Golden Neuron.png",
    "Brain Unit.png",
    "Organic Unit.png",
    "Party Glasses.png",
    "Processing Unit 08.png",
    "Processing Unit 09.png",
    "Red Processing Unit 14.png",
    "Red Processing Unit 11.png",
    "Red Processing Unit 04.png",
    "Red Processing Unit 10.png",
    "Red Processing Unit 06.png",
    "Red Processing Unit 12.png",
    "Red Processing Unit 13.png",
    "Red Processing Unit 07.png",
    "Seed Unit.png",
    "Processing Unit 01.png",
    "Golden Cortex.png",
    "Processing Unit 14.png",
    "Red Processing Unit 09.png",
    "Processing Unit 02.png",
    "Processing Unit 03.png",
    "Red Processing Unit 08.png",
    "Processing Unit 07.png",
    "Processing Unit 13.png",
    "Processing Unit 12.png",
    "Processing Unit 06.png",
    "Processing Unit 10.png",
    "Processing Unit 04.png",
    "Processing Unit 05.png",
    "Processing Unit 11.png",
    "Golden Analyzer.png",
    "Blue Processing Unit 13.png",
    "Blue Sunglasses.png",
    "Sunglasses.png",
    "Blue Processing Unit 06.png",
    "Blue Processing Unit 12.png",
    "Red Sunglasses.png",
    "Blue Processing Unit 04.png",
    "Blue Processing Unit 10.png",
    "Golden Synapse.png",
    "Blue Processing Unit 05.png",
    "Energy Unit.png",
    "Blue Processing Unit 01.png",
    "Red Party Glasses.png",
    "Blue Processing Unit 03.png",
    "Blue Party Glasses.png",
    "Green Processing Unit 13.png",
    "Green Processing Unit 07.png",
    "Green Processing Unit 06.png",
    "Green Processing Unit 12.png",
    "Green Processing Unit 04.png",
    "Green Processing Unit 10.png",
    "None.png",
  ],
  Hat: [
    "Royal Crown.png",
    "Mice Hat.png",
    "Egg Basket.png",
    "Trainer Cap.png",
    "Baseball Cap.png",
    "Propeller Hat.png",
    "Golden Halo.png",
    "Signal Antenna.png",
    "Golden Egg Basket.png",
    "Beanie.png",
    "Bird Hat.png",
    "Gentleman Hat.png",
    "Cooking Hat.png",
    "Adventurer Hat.png",
    "Farmer Hat.png",
    "Mushroom Hat.png",
    "Magic Hat.png",
    "Mining Hat.png",
    "Radio Antenna.png",
    "Plumber Hat.png",
    "Magician Hat.png",
    "Pirate Hat.png",
    "Cowboy Hat.png",
    "None.png",
  ],
  Hand: [
    "Golden Elder Staff.png",
    "Racket.png",
    "Coffe Mug.png",
    "Red Walkie-talkie.png",
    "Green Racket.png",
    "Alien Gun.png",
    "Golden Rail Gun.png",
    "Green Magic Wand.png",
    "Green Lightsaber.png",
    "Green Coffe Mug.png",
    "Walkie-talkie.png",
    "Green Walkie-talkie.png",
    "Green Rail Gun.png",
    "Alien Sword.png",
    "Beer Mug.png",
    "Red Alien Sword.png",
    "Golden Lightsaber.png",
    "Green Beer Mug.png",
    "Green Green Lightsaber.png",
    "Rail Gun.png",
    "Elder Staff.png",
    "Red Lightsaber.png",
    "Green Burger & Fork.png",
    "Burger & Fork.png",
    "Red Magic Wand.png",
    "Green Elder Staff.png",
    "Red Coffe Mug.png",
    "Magic Wand.png",
    "Red Elder Staff.png",
    "Blue Elder Staff.png",
    "Blue Magic Wand.png",
    "Golden Lighter.png",
    "Red Lighter.png",
    "Blue Lighter.png",
    "Green Lighter.png",
    "Lighter.png",
    "Butcher Knife.png",
    "Flash Drive.png",
    "Blue Flash Drive.png",
    "Red Red Lightsaber.png",
    "None.png",
  ],
}

const LAYER_ORDER = [
  { key: "Background", folder: "Background" },
  { key: "Back", folder: "Back" },
  { key: "Body", folder: "Body" },
  { key: "Head", folder: "Head" },
  { key: "Hat", folder: "Hat" },
  { key: "Hand", folder: "Hand" },
]

const backChance = 0.85
const handChance = 0.4
const hatChance = 0.9 // 0.8% chance
const bgChance = 0.02

function pick(arr) {
  return arr[Math.floor(Math.random() * arr.length)]
}

function weightedPick(arr, weights) {
  let total = 0
  arr.forEach((v) => (total += weights[v] || 1))
  let r = Math.random() * total
  for (const v of arr) {
    const w = weights[v] || 1
    if (r < w) return v
    r -= w
  }
  return arr[arr.length - 1]
}

function getHandWeights(pool) {
  const w = {}
  pool.forEach((h) => (w[h] = /\bBlue\b/.test(h) ? 0.1 : 1))
  return w
}

function generateNFTs(count) {
  const combos = new Set()

  // seed special backgrounds with non-None Body & Head
  specialBackgrounds.forEach((bg) => {
    combos.add(
      JSON.stringify({
        Background: bg,
        Back: "None.png",
        Body: "None.png",
        Head: "None.png",
        Hat: "None.png",
        Hand: "None.png",
      })
    )
  })

  const usedGoldenTriples = new Set()

  while (combos.size < count) {
    const bgPool = traitFiles.Background.filter(
      (b) =>
        !specialBackgrounds.includes(b) && b !== "City.png" && b !== "Stars.png"
    )
    const body = pick(traitFiles.Body.filter((b) => b !== "None.png"))
    const isGoldenBody = body.includes("Golden")
    const background =
      Math.random() < (isGoldenBody ? 0.15 : bgChance)
        ? isGoldenBody || (Math.random() < 0.8 && isGoldenBody)
          ? "Stars.png"
          : "City.png"
        : pick(bgPool)

    const colorMatch = body.match(/\b(Red|Blue|Green|Golden)\b/)
    const color = colorMatch ? colorMatch[1] : "Gray"

    let back = "None.png"
    if (Math.random() < backChance) {
      back = pick(traitFiles.Back.filter((b) => b !== "None.png"))
    }

    const multi = multiColorBody.includes(body)
    const headCandidates = multi
      ? traitFiles.Head.filter((h) => !/\bGolden\b/.test(h) && h !== "None.png")
      : color === "Gray"
      ? traitFiles.Head.filter(
          (h) => !/(Red|Blue|Green|Golden)\b/.test(h) && h !== "None.png"
        )
      : traitFiles.Head.filter(
          (h) => new RegExp(`\\b${color}\\b`).test(h) && h !== "None.png"
        )
    const headPool = headCandidates.length
      ? headCandidates
      : traitFiles.Head.filter((h) => h !== "None.png")
    const head = pick(headPool)

    // const hat = Math.random() < hatChance ? pick(traitFiles.Hat) : "None.png"

    if (isGoldenBody) {
      const triple = `${body}|${head}|${back}`
      if (usedGoldenTriples.has(triple)) continue
      usedGoldenTriples.add(triple)
    }

    const handPool = traitFiles.Hand.filter((h) =>
      color === "Gray"
        ? !/(Red|Blue|Green|Golden)\b/.test(h)
        : new RegExp(`\\b${color}\\b`).test(h)
    )
    const hand =
      Math.random() < handChance
        ? weightedPick(handPool, getHandWeights(handPool))
        : "None.png"

    combos.add(
      JSON.stringify({
        Background: background,
        Back: back,
        Body: body,
        Head: head,
        Hat: "None.png",
        Hand: hand,
      })
    )
  }

  // Hats assignment
  const arr = Array.from(combos).map((s) => JSON.parse(s))

  const usage = {}
  traitFiles.Hat.forEach((h) => (usage[h] = 0))
  const maxHatUses = 2

  // 1) Pick exactly one “Mice Hat” on a random non‐special, non‐golden NFT:
  const candidates = arr.filter(
    (o) =>
      !specialBackgrounds.includes(o.Background) && !/\bGolden\b/.test(o.Body)
  )
  if (candidates.length > 0) {
    const one = candidates[Math.floor(Math.random() * candidates.length)]
    one.Hat = "Mice Hat.png"
    usage["Mice Hat.png"] = 1
  }

  arr.forEach((o) => {
    if (o.Hat !== "None.png") return
    // if special no skip
    if (specialBackgrounds.includes(o.Background)) return

    if (Math.random() >= hatChance) {
      o.Hat = "None.png"
      return
    }

    if (/\bGolden\b/.test(o.Body)) {
      if (Math.random() >= hatChance * 0.9) {
        o.Hat = "None.png"
        return
      }

      const hatWeights = {}
      const pool = traitFiles.Hat.filter((h) => h !== "Mice Hat.png")
      o.Hat = weightedPick(pool, hatWeights)
      usage[o.Hat]++
    } else {
      const hatWeights = {}
      const pool = traitFiles.Hat.filter((h) => h !== "Mice Hat.png")
      o.Hat = weightedPick(pool, hatWeights)
      usage[o.Hat]++
    }
  })

  return arr
}

// Encoding spec
const format = {
  Back: { shift: 0, mask: "0xf", bits: 4 }, // 4 bits supports 16 backgrounds
  Body: { shift: 4, mask: "0x3f", bits: 6 }, // 6 bits supports 64 bodies
  Hand: { shift: 10, mask: "0x3f", bits: 6 }, // increased to 6 bits for up to 64 hands
  Hat: { shift: 16, mask: "0x1f", bits: 5 }, // moved to bit 16
  Head: { shift: 21, mask: "0x3f", bits: 6 }, // moved to bit 21
  Background: { shift: 27, mask: "0x1f", bits: 5 }, // now 32 values instead of 16
}

const indices = {}
Object.keys(format).forEach((layer) => {
  indices[layer] = traitFiles[layer].map((f) => f.replace(/\.png$/i, ""))
})

function encodeNFTs(nfts) {
  return nfts.map((o) => {
    let code = 0
    Object.entries(format).forEach(([layer, { shift, bits }]) => {
      const name = (o[layer] || "None.png").replace(/\.png$/i, "")
      const idx = indices[layer].indexOf(name)
      code |= (idx & ((1 << bits) - 1)) << shift
    })
    return code >>> 0
  })
}

// Expose for rendering UI
window.encodedTraits = {
  format,
  indices,
  items: encodeNFTs(generateNFTs(10000)),
}
