<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <base href="./" />
    <title>10k NFT Generator & Filter</title>
    <style>
      body {
        background: #18181b;
        color: #fff;
        font-family: monospace;
        padding: 2rem;
      }
      button,
      select {
        background: #23232b;
        color: #fff;
        border: none;
        border-radius: 5px;
        margin: 0 0.3rem 1rem 0;
        padding: 6px 16px;
      }
      #controls {
        margin-bottom: 1rem;
        display: none;
      }
      #stats {
        margin-bottom: 1rem;
        background: #222;
        border-radius: 12px;
        padding: 12px;
        display: none;
      }
      #previewArea {
        display: flex;
        flex-wrap: wrap;
        gap: 18px;
        margin: 2rem 0;
      }
      .nft-preview {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .nft-stack {
        position: relative;
        width: 120px;
        height: 120px;
        background: #18181b;
      }
      .nft-stack img {
        position: absolute;
        top: 0;
        left: 0;
        width: 120px;
        height: 120px;
      }
      .nft-index {
        color: #aaa;
        font-size: 11px;
      }
      #paging {
        margin: 1.5rem 0 1rem 0;
        display: none;
      }
      #paging button {
        padding: 5px 18px;
      }
      #metadata {
        background: #222;
        color: #fff;
        padding: 12px;
        border-radius: 8px;
        max-height: 200px;
        overflow: auto;
        font-size: 12px;
        white-space: pre;
      }
    </style>
  </head>
  <body>
    <h2>10,000 NFT Generator, Filter & Preview</h2>
    <button id="generate10k">Generate 10,000 NFTs</button>
    <button id="testItems" style="display: none">Test Items</button>
    <pre id="testResults" style="display: none"></pre>
    <div id="controls">
      Filter:
      <select id="filterLayer">
        <option value="">(Choose layer)</option>
        <option value="Back">Back</option>
        <option value="Body">Body</option>
        <option value="Head">Head</option>
        <option value="Hat">Hat</option>
        <option value="Hand">Hand</option>
      </select>
      <select id="filterTrait" style="display: none"></select>
      <button id="clearFilter" style="display: none">Show All</button>
    </div>
    <div id="stats"></div>
    <div id="paging"></div>
    <div id="previewArea"></div>
    <pre id="metadata"></pre>

    <script>
      const specialBackgrounds = ["Pandas 1-1.png", "Dead 1-1.png"]

      const traitFiles = {
        Background: [
          "Blue.png",
          "Green.png",
          "Cyan.png",
          "Stars.png",
          "Red.png",
          "Purple.png",
          "Pandas 1-1.png",
          "Dead 1-1.png",
        ],
        Back: [
          "Fairy Wings.png",
          "Backpack.png",
          "Imp Wings.png",
          "Drone 01.png",
          "Drone 03.png",
          "Drone 02.png",
          "Jetpack.png",
          "Golden Wings.png",
          "Golden Jetpack.png",
          "Angel Wings.png",
        ],
        Body: [
          "Red Mainframe 09.png",
          "Hooded Sweatshirt.png",
          "Lab Coat.png",
          "Red Mainframe 08.png",
          "Red Plumber Overalls.png",
          "Suit.png",
          "Leather Jacket.png",
          "Red Skull Shirt.png",
          "Skull Shirt.png",
          "Butcher Apron.png",
          "Green Butcher Apron.png",
          "Mainframe 03.png",
          "Blue Mainframe 07.png",
          "Blue Mainframe 06.png",
          "Mainframe 02.png",
          "Blue Mainframe 04.png",
          "Blue Mainframe 10.png",
          "Blue Mainframe 05.png",
          "Golden Frame.png",
          "Mainframe 01.png",
          "Mainframe 05.png",
          "Blue Mainframe 01.png",
          "Mainframe 10.png",
          "Mainframe 04.png",
          "Mainframe 06.png",
          "Green Mainframe 09.png",
          "Blue Mainframe 02.png",
          "Green Plumber Overalls.png",
          "Blue Mainframe 03.png",
          "Mainframe 07.png",
          "Green Mainframe 08.png",
          "Green Mainframe 05.png",
          "Golden Chassis.png",
          "Golden Hull.png",
          "Green Mainframe 10.png",
          "Mainframe 09.png",
          "Red Butcher Apron.png",
          "Mainframe 08.png",
          "Green Mainframe 03.png",
          "Blue Mainframe 08.png",
          "Blue Mainframe 09.png",
          "Green Mainframe 02.png",
          "Green Mainframe 01.png",
          "Plumber Overalls.png",
          "Red Mainframe 06.png",
          "Striped Shirt.png",
          "Red Mainframe 05.png",
          "Red Lab Coat.png",
          "Red Mainframe 10.png",
          "Red Mainframe 04.png",
          "Blazer.png",
        ],
        Head: [
          "Golden Neuron.png",
          "Brain Unit.png",
          "Organic Unit.png",
          "Party Glasses.png",
          "Processing Unit 08.png",
          "Processing Unit 09.png",
          "Red Processing Unit 14.png",
          "Red Processing Unit 11.png",
          "Red Processing Unit 04.png",
          "Red Processing Unit 10.png",
          "Red Processing Unit 06.png",
          "Red Processing Unit 12.png",
          "Red Processing Unit 13.png",
          "Red Processing Unit 07.png",
          "Seed Unit.png",
          "Processing Unit 01.png",
          "Golden Cortex.png",
          "Processing Unit 14.png",
          "Red Processing Unit 09.png",
          "Processing Unit 02.png",
          "Processing Unit 03.png",
          "Red Processing Unit 08.png",
          "Processing Unit 07.png",
          "Processing Unit 13.png",
          "Processing Unit 12.png",
          "Processing Unit 06.png",
          "Processing Unit 10.png",
          "Processing Unit 04.png",
          "Processing Unit 05.png",
          "Processing Unit 11.png",
          "Golden Analyzer.png",
          "Blue Processing Unit 13.png",
          "Blue Sunglasses.png",
          "Sunglasses.png",
          "Blue Processing Unit 06.png",
          "Blue Processing Unit 12.png",
          "Red Sunglasses.png",
          "Blue Processing Unit 04.png",
          "Blue Processing Unit 10.png",
          "Golden Synapse.png",
          "Blue Processing Unit 05.png",
          "Energy Unit.png",
          "Blue Processing Unit 01.png",
          "Red Party Glasses.png",
          "Blue Processing Unit 03.png",
          "Blue Party Glasses.png",
          "Green Processing Unit 13.png",
          "Green Processing Unit 07.png",
          "Green Processing Unit 06.png",
          "Green Processing Unit 12.png",
          "Green Processing Unit 04.png",
          "Green Processing Unit 10.png",
        ],
        Hat: [
          "Egg Basket.png",
          "Trainer Cap.png",
          "Baseball Cap.png",
          "Propeller Hat.png",
          "Golden Halo.png",
          "Signal Antenna.png",
          "Golden Egg Basket.png",
          "Beanie.png",
          "Bird Hat.png",
          "Gentleman Hat.png",
          "Cooking Hat.png",
          "Adventurer Hat.png",
          "Farmer Hat.png",
          "Mushroom Hat.png",
          "Magic Hat.png",
          "Mining Hat.png",
          "Radio Antenna.png",
          "Plumber Hat.png",
          "Magician Hat.png",
          "Royal Crown.png",
          "Pirate Hat.png",
          "Cowboy Hat.png",
          "Mice Hat.png",
        ],
        Hand: [
          "Racket.png",
          "Red Red Lightsaber.png",
          "Flash Drive.png",
          "Coffe Mug.png",
          "Red Walkie-talkie.png",
          "Green Racket.png",
          "Butcher Knife.png",
          "Alien Gun.png",
          "Golden Rail Gun.png",
          "Green Magic Wand.png",
          "Green Lightsaber.png",
          "Green Coffe Mug.png",
          "Walkie-talkie.png",
          "Green Walkie-talkie.png",
          "Green Rail Gun.png",
          "Alien Sword.png",
          "Beer Mug.png",
          "Red Alien Sword.png",
          "Golden Lightsaber.png",
          "Green Beer Mug.png",
          "Green Green Lightsaber.png",
          "Rail Gun.png",
          "Elder Staff.png",
          "Red Lightsaber.png",
          "Green Burger & Fork.png",
          "Burger & Fork.png",
          "Red Magic Wand.png",
          "Green Elder Staff.png",
          "Red Coffe Mug.png",
          "Magic Wand.png",
          "Red Elder Staff.png",
          "Blue Elder Staff.png",
          "Blue Magic Wand.png",
        ],
      }

      const LAYER_ORDER = [
        { key: "Background", folder: "Background" },
        { key: "Back", folder: "Back" },
        { key: "Body", folder: "Body" },
        { key: "Head", folder: "Head" },
        { key: "Hat", folder: "Hat" },
        { key: "Hand", folder: "Hand" },
      ]

      const bgWeightsNormal = { "Stars.png": 0.2 }
      const bgWeightsGolden = { "Stars.png": 0.3 }
      const hatWeights = { "Mice Hat.png": 0.5 }
      const backChance = 0.9
      const handChance = 0.25

      function pick(arr) {
        return arr[Math.floor(Math.random() * arr.length)]
      }
      function weightedPick(arr, weights) {
        let total = 0
        arr.forEach((v) => (total += weights[v] || 1))
        let r = Math.random() * total
        for (const v of arr) {
          const w = weights[v] || 1
          if (r < w) return v
          r -= w
        }
        return arr[arr.length - 1]
      }
      function getHandWeights(pool) {
        const w = {}
        pool.forEach((h) => (w[h] = /\bBlue\b/.test(h) ? 0.1 : 1))
        return w
      }

      function generateNFTs(count) {
        const combos = new Set()

        // add the two 1-1s
        specialBackgrounds.forEach((bg) => {
          combos.add(
            JSON.stringify({
              Background: bg,
              Back: null,
              Body: null,
              Head: null,
              Hat: null,
              Hand: null,
            })
          )
        })

        while (combos.size < count) {
          const bgPool = traitFiles.Background.filter(
            (b) => !specialBackgrounds.includes(b)
          )
          const Background = pick(bgPool)

          const Body = pick(traitFiles.Body)
          const match = Body.match(/\b(Red|Blue|Green|Golden)\b/)
          const color = match ? match[1] : null

          const Back =
            Math.random() < backChance
              ? color === "Golden"
                ? pick(traitFiles.Back.filter((b) => b.startsWith("Golden")))
                : pick(traitFiles.Back)
              : null

          const headPool = color
            ? traitFiles.Head.filter((h) =>
                new RegExp(`\\b${color}\\b`).test(h)
              )
            : traitFiles.Head.filter((h) => !/(Red|Blue|Green|Golden)/.test(h))
          const Head = headPool.length ? pick(headPool) : pick(traitFiles.Head)

          const handPool = color
            ? traitFiles.Hand.filter((h) =>
                new RegExp(`\\b${color}\\b`).test(h)
              )
            : traitFiles.Hand
          const Hand =
            Math.random() < handChance
              ? weightedPick(handPool, getHandWeights(handPool))
              : null

          combos.add(
            JSON.stringify({ Background, Back, Body, Head, Hat: null, Hand })
          )
        }

        const arr = Array.from(combos).map((s) => JSON.parse(s))

        // assign hats, skip for 1-1s
        const usage = {}
        traitFiles.Hat.forEach((h) => (usage[h] = 0))
        const maxUses = 2

        arr.forEach((o) => {
          if (specialBackgrounds.includes(o.Background)) {
            o.Hat = null
            return
          }
          if (o.Body && o.Body.includes("Golden")) {
            const avail = traitFiles.Hat.filter((h) => usage[h] < maxUses)
            if (avail.length) {
              const h = pick(avail)
              o.Hat = h
              usage[h]++
            } else {
              o.Hat = null
            }
          } else {
            o.Hat = weightedPick(traitFiles.Hat, hatWeights)
          }
        })

        return arr
      }

      function loadImageSafe(path) {
        return new Promise((res) => {
          const img = new Image()
          img.onload = () => res(img)
          img.onerror = () => res(null)
          img.src = path
        })
      }
      async function renderNFT(traits) {
        const stack = document.createElement("div")
        stack.className = "nft-stack"
        for (const layer of LAYER_ORDER) {
          const file = traits[layer.key]
          if (!file) continue
          const img = await loadImageSafe(
            `traits/${layer.folder}/${encodeURIComponent(file)}`
          )
          if (img) stack.appendChild(img)
        }
        return stack
      }

      let nft10k = [],
        filtered = [],
        currentPage = 0,
        pageSize = 50

      function renderPage(arr, page) {
        const area = document.getElementById("previewArea")
        area.innerHTML = ""
        ;(async () => {
          const start = page * pageSize
          for (let i = 0; i < Math.min(pageSize, arr.length - start); i++) {
            const wrap = document.createElement("div")
            wrap.className = "nft-preview"
            wrap.appendChild(await renderNFT(arr[start + i]))
            wrap.innerHTML += `<span class="nft-index">#${start + i}</span>`
            area.appendChild(wrap)
          }
        })()
      }
      function updatePaging(total, page) {
        const pg = document.getElementById("paging")
        pg.innerHTML = ""
        const pages = Math.ceil(total / pageSize)
        pg.style.display = pages > 1 ? "block" : "none"
        for (let p = 0; p < pages; p++) {
          const b = document.createElement("button")
          b.textContent = p + 1
          if (p === page) b.style.background = "#666"
          b.onclick = () => {
            currentPage = p
            renderPage(filtered, p)
            updatePaging(filtered.length, p)
            updateStats(filtered)
          }
          pg.appendChild(b)
        }
      }
      function updateStats(arr) {
        const sd = document.getElementById("stats")
        sd.style.display = "block"
        let html = `<strong>Total:</strong> ${arr.length}`
        const layer = document.getElementById("filterLayer").value
        if (layer) {
          const cnt = {}
          arr.forEach((o) => (cnt[o[layer]] = (cnt[o[layer]] || 0) + 1))
          html += `<br><strong>${layer} Distribution:</strong><br>`
          html += Object.entries(cnt)
            .map(([k, v]) => `${k}: ${v}`)
            .join(", ")
        }
        sd.innerHTML = html
      }

      function updateMetadata() {
        const format = {
          Back: { shift: 0, mask: "0xf", bits: 4 },
          Body: { shift: 4, mask: "0x3f", bits: 6 },
          Hand: { shift: 10, mask: "0x1f", bits: 5 },
          Hat: { shift: 15, mask: "0x1f", bits: 5 },
          Head: { shift: 20, mask: "0x3f", bits: 6 },
          Background: { shift: 26, mask: "0xf", bits: 4 },
        }
        document.getElementById("testItems").style.display = "inline-block"
        const indices = {}
        ;["Back", "Body", "Hand", "Hat", "Head", "Background"].forEach(
          (layer) => {
            indices[layer] = traitFiles[layer].map((f) =>
              f.replace(/\.png$/i, "")
            )
          }
        )

        const items = nft10k.map((traits) => {
          let code = 0
          Object.entries(format).forEach(([layer, { shift, bits }]) => {
            const name = (traits[layer] || "").replace(/\.png$/i, "")
            const idx = indices[layer].indexOf(name)
            code |= (idx & ((1 << bits) - 1)) << shift
          })
          return code
        })

        document.getElementById("metadata").textContent = JSON.stringify(
          { format, indices, items },
          null,
          2
        )
      }

      document.getElementById("generate10k").onclick = () => {
        nft10k = generateNFTs(10000)
        filtered = nft10k
        currentPage = 0
        document.getElementById("controls").style.display = "block"
        renderPage(filtered, 0)
        updatePaging(filtered.length, 0)
        updateStats(filtered)
        updateMetadata()
      }

      document.getElementById("filterLayer").onchange = function () {
        const sel = document.getElementById("filterTrait")
        sel.style.display = this.value ? "inline-block" : "none"
        sel.innerHTML = ""
        if (this.value)
          traitFiles[this.value].forEach((t) => {
            const o = document.createElement("option")
            o.value = o.textContent = t
            sel.appendChild(o)
          })
        document.getElementById("clearFilter").style.display = "none"
      }
      document.getElementById("filterTrait").onchange = function () {
        const layer = document.getElementById("filterLayer").value
        filtered = nft10k.filter((o) => o[layer] === this.value)
        currentPage = 0
        renderPage(filtered, 0)
        updatePaging(filtered.length, 0)
        updateStats(filtered)
        document.getElementById("clearFilter").style.display = "inline-block"
      }
      document.getElementById("clearFilter").onclick = function () {
        filtered = nft10k
        currentPage = 0
        renderPage(filtered, 0)
        updatePaging(filtered.length, 0)
        updateStats(filtered)
        this.style.display = "none"
        document.getElementById("filterTrait").style.display = "none"
        document.getElementById("filterLayer").value = ""
      }

      document.getElementById("testItems").onclick = function () {
        const { format, indices, items } = JSON.parse(
          document.getElementById("metadata").textContent
        )
        function decodeItem(code, orig) {
          const decoded = {}
          for (const layer in format) {
            if (orig[layer] == null) {
              decoded[layer] = null
            } else {
              const { shift, bits } = format[layer]
              const mask = (1 << bits) - 1
              const idx = (code >> shift) & mask
              decoded[layer] = indices[layer][idx] || null
            }
          }
          return decoded
        }
        const results = items.slice(0, 10).map((code, i) => ({
          index: i,
          original: nft10k[i],
          decoded: decodeItem(code, nft10k[i]),
        }))
        const out = document.getElementById("testResults")
        out.style.display = "block"
        out.textContent = JSON.stringify(results, null, 2)
      }
    </script>
  </body>
</html>
